
# Basis Swap SWPM Comparison (molib)

molib code map (post-refactor):
- Trade builder: molib/swap/api.go (swap.InterestRateSwap)
- Core methods: molib/swap/common.go (GenerateSchedule, GetForwardRates, GetDiscountFactors, GetZeroRates, NPV, SolveParSpread)
- Conventions/presets: molib/instruments/swaps/conventions.go
- Embedded curve fixtures: molib/marketdata/*.go

Execution:
- cd molib
- go run ./examples/basis_swap_par_spread.go

**Objective:** 
Debug `go run ./examples/basis_swap_par_spread.go` by comparing against Bloomberg SWPM reference.
**Current State:**
- molib results are close to SWPM, but the spread and NPV discrepancies remain
- Target: minimize NPV gap to < 10 (or match SWPM within rounding tolerance)
**Debug Approach:**
Use `swap/api.go` as the primary debugging tool. 
Investigate potential sources of discrepancy:
1. **Day count conventions** — ACT/365F for both legs
2. **Schedule generation** — stub periods, business day adjustments
3. **Forward rate calculation** — compounding, rate averaging
4. **Payment timing** — pay delay, settlement lag

---

**Key Improvements:**
1. Quantified target tolerance (< 1bp)
2. Listed specific debug areas to investigate
3. Clarified role of `swap/api.go` (entry point for debugging)
4. Defined expected output format
5. Action-oriented: identify → fix → verify

Should I add specific SWPM reference values if you have them?


**SWPM**
- Swap: TONAR vs TIBOR6M Basis Swap
- Trade: 2025-12-16
- Valuation: 2025-12-16
- Curve: 2025-12-15
- Effective: 2035-12-18
- Maturity: 2065-12-18
- Notional: 10MM
- NPV: 871351
- Spread(Receive): +57.000

Notes:
- Ensure fixtures match Curve date: run ./scripts/basis_swap.sh 20251215 before running the example.
- The SWPM NPV shown here is for Notional = 10MM; molib NPV scales linearly with Notional, but the fair spread should not.
- Check: summing PV from the two cashflow tables below gives net PV = -33 (≈ 0), so the SWPM top-line NPV is not consistent with the cashflows below.

molib (current run with Notional = 10MM):
- NPV @ 0 spread: -50647.02
- Fair rec 3M spread: 3.254657 bp

SWPM cashflow PV sums (from PV column):
- 6M leg PV sum: -962764
- 3M leg PV sum:  962731
- Net PV:            -33

**Compare molib output vs SWPM reference for:**
1. **Schedule:** PayDate, AccrualStart/End, AccrualDays, ResetDate
2. **Rates:** ResetRate, EquivalentCoupon, ZeroRate
3. **Cashflows:** Payment amounts, Principal exchanges
4. **Discounting:** DiscountFactor consistency with ZeroRate
5. **Final PV:** Leg NPVs and net spread result

**SWPM Reference Data:**
*Receive Leg (TONAR, annual receive):*
~~~csv
PayDate,AccrualStartDate,AccrualEndDate,AccrualDays,Notional,Principal,ResetDate,EquivalentCoupon,Payment,Discount,Zerate,PV
12/18/2035,,,,,-10000000,,,-10000000,0.836581,1.782368,-8365808
12/22/2036,12/18/2035,12/18/2036,366,10000000,0,12/17/2036,3.29566,330469,0.814069,1.865909,269024
12/22/2037,12/18/2036,12/18/2037,365,10000000,0,12/17/2037,3.52965,352965,0.790658,1.953404,279074
12/22/2038,12/18/2037,12/20/2038,367,10000000,0,12/17/2038,3.78253,380325,0.766035,2.046332,291342
12/21/2039,12/20/2038,12/19/2039,364,10000000,0,12/16/2039,3.78419,377382,0.742243,2.125804,280109
12/20/2040,12/19/2039,12/18/2040,365,10000000,0,12/17/2040,3.78433,378432,0.719118,2.194994,272137
12/20/2041,12/18/2040,12/18/2041,365,10000000,0,12/17/2041,4.31590,431590,0.693143,2.287609,299153
12/22/2042,12/18/2041,12/18/2042,365,10000000,0,12/17/2042,4.31737,431736,0.667972,2.369763,288387
12/22/2043,12/18/2042,12/18/2043,365,10000000,0,12/17/2043,4.31737,431736,0.643845,2.442380,277971
12/21/2044,12/18/2043,12/19/2044,367,10000000,0,12/16/2044,4.31775,434140,0.620589,2.507365,269422
12/20/2045,12/19/2044,12/18/2045,364,10000000,0,12/15/2045,4.31718,430534,0.598234,2.565707,257560
12/20/2046,12/18/2045,12/18/2046,365,10000000,0,12/17/2046,4.43563,443563,0.575965,2.624101,255477
12/20/2047,12/18/2046,12/18/2047,365,10000000,0,12/17/2047,4.43629,443628,0.554525,2.677193,246003
12/22/2048,12/18/2047,12/18/2048,366,10000000,0,12/17/2048,4.43649,444864,0.533718,2.726053,237431
12/22/2049,12/18/2048,12/20/2049,367,10000000,0,12/17/2049,4.43669,446100,0.513851,2.770466,229228
12/21/2050,12/20/2049,12/19/2050,364,10000000,0,12/16/2050,4.43608,442393,0.494775,2.811223,218884
12/20/2051,12/19/2050,12/18/2051,364,10000000,0,12/15/2051,4.39484,438280,0.476597,2.847326,208882
12/20/2052,12/18/2051,12/18/2052,366,10000000,0,12/17/2052,4.39501,440705,0.458992,2.880942,202280
12/22/2053,12/18/2052,12/18/2053,365,10000000,0,12/17/2053,4.39481,439481,0.441992,2.912235,194247
12/22/2054,12/18/2053,12/18/2054,365,10000000,0,12/17/2054,4.39481,439481,0.425710,2.941208,187091
12/22/2055,12/18/2054,12/20/2055,367,10000000,0,12/17/2055,4.39521,441929,0.410028,2.968242,181203
12/20/2056,12/20/2055,12/18/2056,364,10000000,0,12/15/2056,4.27668,426496,0.395413,2.989813,168642
12/20/2057,12/18/2056,12/18/2057,365,10000000,0,12/17/2057,4.27654,427654,0.381280,3.010095,163056
12/20/2058,12/18/2057,12/18/2058,365,10000000,0,12/17/2058,4.27654,427654,0.367653,3.029149,157228
12/22/2059,12/18/2058,12/18/2059,365,10000000,0,12/17/2059,4.27654,427654,0.354442,3.047179,151578
12/22/2060,12/18/2059,12/20/2060,368,10000000,0,12/17/2060,4.27710,431225,0.341741,3.064124,147367
12/21/2061,12/20/2060,12/19/2061,364,10000000,0,12/16/2061,4.20766,419613,0.329778,3.078207,138379
12/20/2062,12/19/2061,12/18/2062,364,10000000,0,12/15/2062,4.20748,419594,0.318234,3.091532,133529
12/20/2063,12/18/2062,12/18/2063,365,10000000,0,12/17/2063,4.20765,420765,0.307064,3.104192,129201
12/22/2064,12/18/2063,12/18/2064,366,10000000,0,12/17/2064,4.20783,421936,0.296199,3.116299,124977
12/22/2065,12/18/2064,12/18/2065,365,10000000,10000000,12/17/2065,4.20765,10420765,0.285803,3.127706,2978283
~~~

*Pay Leg (TIBOR6M, semi-annual pay):*
~~~csv
PayDate,AccrualStartDate,AccrualEndDate,AccrualDays,Notional,Principal,ResetDate,EquivalentCoupon,Payment,Discount,ZeroRate,PV
12/18/2035,,,,10000000,10000000,,,,0.836581,1.782368,8365808
06/20/2036,12/18/2035,06/18/2036,183,-10000000,0,12/14/2035,3.40101,-170516,0.825258,1.826037,-140720
12/22/2036,06/18/2036,12/18/2036,183,-10000000,0,06/16/2036,3.40101,-170516,0.814069,1.865909,-138812
06/22/2037,12/18/2036,06/18/2037,182,-10000000,0,12/16/2036,3.40085,-169576,0.802313,1.911406,-136053
12/22/2037,06/18/2037,12/18/2037,183,-10000000,0,06/16/2037,3.40289,-170610,0.790658,1.953404,-134894
06/22/2038,12/18/2037,06/18/2038,182,-10000000,0,12/16/2037,3.74576,-186774,0.778283,2.001596,-145363
12/22/2038,06/18/2038,12/20/2038,185,-10000000,0,06/16/2038,3.74633,-189882,0.766035,2.046332,-145456
06/22/2039,12/20/2038,06/20/2039,182,-10000000,0,12/16/2038,3.74576,-186774,0.754045,2.087533,-140836
12/21/2039,06/20/2039,12/19/2039,182,-10000000,0,06/16/2039,3.74576,-186774,0.742243,2.125804,-138632
06/20/2040,12/19/2039,06/18/2040,182,-10000000,0,12/15/2039,3.74576,-186774,0.730626,2.161447,-136462
12/20/2040,06/18/2040,12/18/2040,183,-10000000,0,06/14/2040,3.74910,-187968,0.719118,2.194994,-135171
06/20/2041,12/18/2040,06/18/2041,182,-10000000,0,12/14/2040,4.32332,-215573,0.706047,2.242666,-152205
12/20/2041,06/18/2041,12/18/2041,183,-10000000,0,06/14/2041,4.32357,-216770,0.693143,2.287609,-150253
06/20/2042,12/18/2041,06/18/2042,182,-10000000,0,12/16/2041,4.32332,-215573,0.680544,2.329600,-146707
12/22/2042,06/18/2042,12/18/2042,183,-10000000,0,06/16/2042,4.32357,-216770,0.667972,2.369763,-144796
06/22/2043,12/18/2042,06/18/2043,182,-10000000,0,12/16/2042,4.32332,-215573,0.655830,2.407008,-141379
12/22/2043,06/18/2043,12/18/2043,183,-10000000,0,06/16/2043,4.32357,-216770,0.643845,2.442380,-139566
06/22/2044,12/18/2043,06/20/2044,185,-10000000,0,12/16/2043,4.32408,-219165,0.632078,2.475838,-138529
12/21/2044,06/20/2044,12/19/2044,182,-10000000,0,06/16/2044,4.32332,-215573,0.620589,2.507365,-133782
06/21/2045,12/19/2044,06/19/2045,182,-10000000,0,12/15/2044,4.32332,-215573,0.609309,2.537281,-131350
12/20/2045,06/19/2045,12/18/2045,182,-10000000,0,06/15/2045,4.32332,-215573,0.598234,2.565707,-128963
06/20/2046,12/18/2045,06/18/2046,182,-10000000,0,12/14/2045,4.38574,-218685,0.587024,2.595535,-128373
12/20/2046,06/18/2046,12/18/2046,183,-10000000,0,06/14/2046,4.38600,-219900,0.575965,2.624101,-126655
06/20/2047,12/18/2046,06/18/2047,182,-10000000,0,12/14/2046,4.38574,-218685,0.565173,2.651191,-123595
12/20/2047,06/18/2047,12/18/2047,183,-10000000,0,06/14/2047,4.38600,-219900,0.554525,2.677193,-121940
06/22/2048,12/18/2047,06/18/2048,183,-10000000,0,12/16/2047,4.38600,-219900,0.543966,2.702302,-119618
12/22/2048,06/18/2048,12/18/2048,183,-10000000,0,06/16/2048,4.38600,-219900,0.533718,2.726053,-117364
06/22/2049,12/18/2048,06/18/2049,182,-10000000,0,12/16/2048,4.38574,-218685,0.523717,2.748671,-114529
12/22/2049,06/18/2049,12/20/2049,185,-10000000,0,06/16/2049,4.38652,-222330,0.513851,2.770466,-114244
06/22/2050,12/20/2049,06/20/2050,182,-10000000,0,12/16/2049,4.38574,-218685,0.504222,2.791259,-110266
12/21/2050,06/20/2050,12/19/2050,182,-10000000,0,06/16/2050,4.38574,-218685,0.494775,2.811223,-108200
06/21/2051,12/19/2050,06/19/2051,182,-10000000,0,12/15/2050,4.33047,-215930,0.485601,2.829627,-104855
12/20/2051,06/19/2051,12/18/2051,182,-10000000,0,06/15/2051,4.33047,-215930,0.476597,2.847326,-102911
06/20/2052,12/18/2051,06/18/2052,183,-10000000,0,12/14/2051,4.33073,-217129,0.467711,2.864452,-101553
12/20/2052,06/18/2052,12/18/2052,183,-10000000,0,06/14/2052,4.33073,-217129,0.458992,2.880942,-99660
06/20/2053,12/18/2052,06/18/2053,182,-10000000,0,12/16/2052,4.33047,-215930,0.450481,2.896747,-97272
12/22/2053,06/18/2053,12/18/2053,183,-10000000,0,06/16/2053,4.33073,-217129,0.441992,2.912235,-95969
06/22/2054,12/18/2053,06/18/2054,182,-10000000,0,12/16/2053,4.33047,-215930,0.433797,2.926936,-93669
12/22/2054,06/18/2054,12/18/2054,183,-10000000,0,06/16/2054,4.33073,-217129,0.425710,2.941208,-92434
06/22/2055,12/18/2054,06/18/2055,182,-10000000,0,12/16/2054,4.33047,-215930,0.417816,2.954922,-90219
12/22/2055,06/18/2055,12/20/2055,185,-10000000,0,06/16/2055,4.32934,-219432,0.410028,2.968242,-89973
06/21/2056,12/20/2055,06/19/2056,182,-10000000,0,12/16/2055,4.21356,-210100,0.402654,2.979203,-84597
12/20/2056,06/19/2056,12/18/2056,182,-10000000,0,06/15/2056,4.21356,-210100,0.395413,2.989813,-83076
06/20/2057,12/18/2056,06/18/2057,182,-10000000,0,12/14/2056,4.21356,-210100,0.388302,3.000087,-81582
12/20/2057,06/18/2057,12/18/2057,183,-10000000,0,06/14/2057,4.21380,-211267,0.381280,3.010095,-80552
06/20/2058,12/18/2057,06/18/2058,182,-10000000,0,12/14/2057,4.21356,-210100,0.374424,3.019743,-78666
12/20/2058,06/18/2058,12/18/2058,183,-10000000,0,06/14/2058,4.21380,-211267,0.367653,3.029149,-77673
06/20/2059,12/18/2058,06/18/2059,182,-10000000,0,12/16/2058,4.21356,-210100,0.361041,3.038226,-75855
12/22/2059,06/18/2059,12/18/2059,183,-10000000,0,06/16/2059,4.21380,-211267,0.354442,3.047179,-74882
06/22/2060,12/18/2059,06/18/2060,183,-10000000,0,12/16/2059,4.21380,-211267,0.348033,3.055777,-73528
12/22/2060,06/18/2060,12/20/2060,185,-10000000,0,06/16/2060,4.21317,-213544,0.341741,3.064124,-72976
06/22/2061,12/20/2060,06/20/2061,182,-10000000,0,12/16/2060,4.14507,-206685,0.335706,3.071264,-69385
12/21/2061,06/20/2061,12/19/2061,182,-10000000,0,06/16/2061,4.14507,-206685,0.329778,3.078207,-68160
06/21/2062,12/19/2061,06/19/2062,182,-10000000,0,12/15/2061,4.14507,-206685,0.323955,3.084960,-66956
12/20/2062,06/19/2062,12/18/2062,182,-10000000,0,06/15/2062,4.14507,-206685,0.318234,3.091532,-65774
06/20/2063,12/18/2062,06/18/2063,182,-10000000,0,12/14/2062,4.14507,-206685,0.312615,3.097929,-64613
12/20/2063,06/18/2063,12/18/2063,183,-10000000,0,06/14/2063,4.14531,-207833,0.307064,3.104192,-63818
06/20/2064,12/18/2063,06/18/2064,183,-10000000,0,12/14/2063,4.14531,-207833,0.301612,3.110292,-62697
12/22/2064,06/18/2064,12/18/2064,183,-10000000,0,06/16/2064,4.14531,-207833,0.296199,3.116299,-61560
06/22/2065,12/18/2064,06/18/2065,182,-10000000,0,12/16/2064,4.14507,-206685,0.290969,3.122059,-60139
12/22/2065,06/18/2065,12/18/2065,183,-10000000,-10000000,06/16/2065,4.14531,-10207833,0.285803,3.127706,-2917426
~~~
**Output:** Create a comparison table showing discrepancies row-by-row. Identify root cause if spread differs from 57.35bp.
